<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Interactive visualization of school threats across the United States. Explore data by state, threat type, school type, and more.">
<meta name="keywords" content="school threats, school safety, US, data visualization, interactive map">
<meta property="og:title" content="US School Threats - Interactive Data Visualization">
<meta property="og:description" content="Explore 520+ school threat incidents across all 50 US states with interactive maps, charts, and filterable data.">
<meta property="og:type" content="website">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="US School Threats - Interactive Data Visualization">
<meta name="twitter:description" content="Explore school threat incidents across the US with interactive maps and charts.">
<title>US School Threats - 2025–2026</title>
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<style>
  :root {
    --bg-primary: #0f1117;
    --bg-secondary: #1a1d27;
    --bg-card: #1e2130;
    --bg-hover: #262a3a;
    --border: #2a2e3f;
    --text-primary: #e8eaed;
    --text-secondary: #9aa0b0;
    --text-muted: #6b7280;
    --accent-blue: #4f8ff7;
    --accent-red: #ef4444;
    --accent-green: #22c55e;
    --accent-orange: #f59e0b;
    --accent-purple: #a78bfa;
    --radius: 10px;
    --shadow: 0 4px 24px rgba(0,0,0,0.3);
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    line-height: 1.6;
    min-height: 100vh;
  }
  .container { max-width: 1440px; margin: 0 auto; padding: 0 24px; }

  /* Header */
  .header {
    background: linear-gradient(135deg, #141728 0%, #1a1d2e 100%);
    border-bottom: 1px solid var(--border);
    padding: 28px 0;
  }
  .header-inner { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 16px; }
  .header h1 { font-size: 26px; font-weight: 700; letter-spacing: -0.5px; }
  .header h1 span { color: var(--accent-blue); }
  .stats { display: flex; gap: 32px; flex-wrap: wrap; }
  .stat { text-align: center; }
  .stat-value { font-size: 28px; font-weight: 700; color: var(--accent-blue); }
  .stat-label { font-size: 12px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; }

  /* Card */
  .card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding: 20px;
    margin-bottom: 20px;
  }
  .card-title {
    font-size: 14px; font-weight: 600; text-transform: uppercase;
    letter-spacing: 1px; color: var(--text-secondary); margin-bottom: 16px;
  }

  /* Map */
  .map-section { margin-top: 24px; }
  .map-container { position: relative; }
  .map-container svg { width: 100%; height: auto; }
  .state-path {
    stroke: var(--bg-primary); stroke-width: 0.8;
    cursor: pointer; transition: opacity 0.15s;
  }
  .state-path:hover { opacity: 0.8; stroke: #fff; stroke-width: 1.5; }
  .state-path.selected { stroke: var(--accent-orange); stroke-width: 2.5; }
  .tooltip {
    position: fixed; pointer-events: none; background: #1e2130ee;
    border: 1px solid var(--border); border-radius: 6px;
    padding: 8px 12px; font-size: 13px; z-index: 100; display: none;
    box-shadow: 0 8px 24px rgba(0,0,0,0.4);
  }
  .tooltip .tt-state { font-weight: 600; }
  .tooltip .tt-count { color: var(--accent-blue); }
  .legend { display: flex; align-items: center; gap: 8px; margin-top: 12px; justify-content: center; }
  .legend-bar { width: 200px; height: 10px; border-radius: 5px; }
  .legend span { font-size: 11px; color: var(--text-secondary); }

  /* Charts row */
  .charts-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 20px; }
  .chart-wrap canvas { max-height: 280px; }

  /* Filters */
  .filters-bar {
    display: flex; flex-wrap: wrap; gap: 12px; align-items: flex-end;
    margin-top: 20px; padding: 16px 20px;
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: var(--radius);
  }
  .filter-group { display: flex; flex-direction: column; gap: 4px; }
  .filter-group label { font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
  .filter-group select {
    background: var(--bg-secondary); color: var(--text-primary);
    border: 1px solid var(--border); border-radius: 6px;
    padding: 8px 28px 8px 10px; font-size: 13px; cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%239aa0b0' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E");
    background-repeat: no-repeat; background-position: right 8px center;
  }
  .filter-group select:focus { outline: none; border-color: var(--accent-blue); }
  .filter-group input[type="date"] {
    background: var(--bg-secondary); color: var(--text-primary);
    border: 1px solid var(--border); border-radius: 6px;
    padding: 7px 10px; font-size: 13px; cursor: pointer;
    color-scheme: dark;
  }
  .filter-group input[type="date"]:focus { outline: none; border-color: var(--accent-blue); }
  .btn {
    padding: 8px 20px; border: none; border-radius: 6px;
    font-size: 13px; font-weight: 600; cursor: pointer; transition: background 0.15s;
  }
  .btn-primary { background: var(--accent-blue); color: #fff; }
  .btn-primary:hover { background: #3b7be6; }
  .btn-secondary { background: var(--bg-secondary); color: var(--text-secondary); border: 1px solid var(--border); }
  .btn-secondary:hover { background: var(--bg-hover); }
  .btn-danger { background: var(--accent-red); color: #fff; }
  .btn-danger:hover { background: #dc2626; }
  .active-filter-tag {
    display: inline-flex; align-items: center; gap: 6px;
    background: #4f8ff722; color: var(--accent-blue); border: 1px solid #4f8ff744;
    border-radius: 20px; padding: 4px 12px; font-size: 12px; margin-top: 8px;
  }
  .active-filters { margin-top: 8px; display: flex; flex-wrap: wrap; gap: 6px; }

  /* Filter count badge */
  .filter-count-badge {
    display: inline-flex; align-items: center; justify-content: center;
    background: var(--accent-blue); color: #fff; font-size: 11px; font-weight: 700;
    min-width: 20px; height: 20px; border-radius: 10px; padding: 0 6px;
    margin-left: 8px;
  }
  .filter-count-badge.hidden { display: none; }

  /* Multi-select dropdown */
  .multi-select {
    position: relative; min-width: 140px;
  }
  .multi-select-trigger {
    background: var(--bg-secondary); color: var(--text-primary);
    border: 1px solid var(--border); border-radius: 6px;
    padding: 8px 28px 8px 10px; font-size: 13px; cursor: pointer;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%239aa0b0' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E");
    background-repeat: no-repeat; background-position: right 8px center;
    user-select: none;
  }
  .multi-select-trigger:focus { outline: none; border-color: var(--accent-blue); }
  .multi-select-dropdown {
    display: none; position: absolute; top: 100%; left: 0; z-index: 50;
    background: var(--bg-secondary); border: 1px solid var(--border);
    border-radius: 6px; margin-top: 4px; max-height: 220px; overflow-y: auto;
    min-width: 100%; box-shadow: 0 8px 24px rgba(0,0,0,0.5);
  }
  .multi-select-dropdown.open { display: block; }
  .multi-select-dropdown label {
    display: flex; align-items: center; gap: 8px;
    padding: 6px 12px; font-size: 13px; cursor: pointer;
    text-transform: none; letter-spacing: normal; color: var(--text-primary);
  }
  .multi-select-dropdown label:hover { background: var(--bg-hover); }
  .multi-select-dropdown input[type="checkbox"] {
    accent-color: var(--accent-blue); width: 14px; height: 14px; cursor: pointer;
  }

  /* Export buttons */
  .export-btn {
    background: var(--bg-hover); color: var(--accent-blue); border: 1px solid var(--border);
    padding: 5px 14px; border-radius: 6px; font-size: 12px; cursor: pointer; font-weight: 500;
    transition: background 0.2s;
  }
  .export-btn:hover { background: var(--accent-blue); color: #fff; }

  /* Table */
  .table-section { margin-top: 20px; margin-bottom: 40px; }
  .table-info { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
  .table-info span { font-size: 13px; color: var(--text-secondary); }
  .table-wrap { overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  thead th {
    background: var(--bg-secondary); color: var(--text-secondary);
    padding: 10px 12px; text-align: left; font-weight: 600; font-size: 11px;
    text-transform: uppercase; letter-spacing: 0.5px;
    cursor: pointer; user-select: none; white-space: nowrap;
    border-bottom: 2px solid var(--border); position: sticky; top: 0;
  }
  thead th:hover { color: var(--text-primary); }
  thead th .sort-arrow { margin-left: 4px; font-size: 10px; }
  tbody tr { border-bottom: 1px solid var(--border); transition: background 0.1s; cursor: pointer; }
  tbody tr:hover { background: var(--bg-hover); }
  tbody td { padding: 10px 12px; color: var(--text-primary); }
  .details-truncated { max-width: 260px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .expanded-row td { padding: 16px 12px; background: var(--bg-secondary); }
  .expanded-content { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 10px; }
  .expanded-content .field { }
  .expanded-content .field-label { font-size: 10px; text-transform: uppercase; color: var(--text-muted); letter-spacing: 0.5px; }
  .expanded-content .field-value { font-size: 13px; color: var(--text-primary); }
  .badge {
    display: inline-block; padding: 2px 8px; border-radius: 4px;
    font-size: 11px; font-weight: 600;
  }
  .badge-bomb { background: #ef444422; color: #f87171; }
  .badge-shooting { background: #f59e0b22; color: #fbbf24; }
  .badge-threat { background: #4f8ff722; color: #60a5fa; }
  .badge-other { background: #a78bfa22; color: #c4b5fd; }

  /* Pagination */
  .pagination { display: flex; justify-content: center; align-items: center; gap: 6px; margin-top: 16px; }
  .pagination button {
    background: var(--bg-secondary); color: var(--text-secondary);
    border: 1px solid var(--border); border-radius: 6px;
    padding: 6px 12px; font-size: 13px; cursor: pointer;
  }
  .pagination button:hover { background: var(--bg-hover); }
  .pagination button.active { background: var(--accent-blue); color: #fff; border-color: var(--accent-blue); }
  .pagination button:disabled { opacity: 0.4; cursor: default; }

  /* Responsive */
  @media (max-width: 900px) {
    .charts-row { grid-template-columns: 1fr; }
    .header-inner { flex-direction: column; text-align: center; }
    .stats { justify-content: center; }
  }
</style>
</head>
<body>

<div class="tooltip" id="tooltip"></div>

<div class="header">
  <div class="container header-inner">
    <h1>US School Threats &mdash; <span>2025–2026</span></h1>
    <div class="stats">
      <div class="stat"><div class="stat-value" id="stat-total">--</div><div class="stat-label">Total Incidents</div></div>
      <div class="stat"><div class="stat-value" id="stat-states">--</div><div class="stat-label">States Affected</div></div>
      <div class="stat"><div class="stat-value" id="stat-threat">--</div><div class="stat-label">Most Common Threat</div></div>
    </div>
  </div>
</div>

<div class="container">
  <!-- Map -->
  <div class="map-section card">
    <div class="card-title">Incidents by State</div>
    <div class="map-container" id="map"></div>
    <div class="legend">
      <span>0</span>
      <div class="legend-bar" id="legend-bar"></div>
      <span id="legend-max">--</span>
    </div>
  </div>

  <!-- Charts -->
  <div class="charts-row">
    <div class="card chart-wrap"><div class="card-title">Threats by Region</div><canvas id="chart-region"></canvas></div>
    <div class="card chart-wrap"><div class="card-title">Top 10 States</div><canvas id="chart-states"></canvas></div>
    <div class="card chart-wrap"><div class="card-title">Threat Type Breakdown</div><canvas id="chart-types"></canvas></div>
  </div>

  <!-- Filters -->
  <div class="filters-bar" id="filters-bar">
    <div class="filter-group"><label>Date From</label><input type="date" id="f-date-start"></div>
    <div class="filter-group"><label>Date To</label><input type="date" id="f-date-end"></div>
    <div class="filter-group"><label>State</label><select id="f-state"><option value="">All States</option></select></div>
    <div class="filter-group"><label>Region</label><select id="f-region"><option value="">All Regions</option></select></div>
    <div class="filter-group">
      <label>Threat Type</label>
      <div class="multi-select" id="ms-type">
        <div class="multi-select-trigger" tabindex="0">All Types</div>
        <div class="multi-select-dropdown"></div>
      </div>
    </div>
    <div class="filter-group"><label>School Type</label><select id="f-school"><option value="">All School Types</option></select></div>
    <div class="filter-group">
      <label>Conveyance</label>
      <div class="multi-select" id="ms-conveyance">
        <div class="multi-select-trigger" tabindex="0">All</div>
        <div class="multi-select-dropdown"></div>
      </div>
    </div>
    <div class="filter-group">
      <label>Outcome</label>
      <div class="multi-select" id="ms-custody">
        <div class="multi-select-trigger" tabindex="0">All</div>
        <div class="multi-select-dropdown"></div>
      </div>
    </div>
    <div class="filter-group"><label>Gender</label><select id="f-gender"><option value="">All</option></select></div>
    <button class="btn btn-primary" id="btn-apply">Apply <span class="filter-count-badge hidden" id="filter-badge">0</span></button>
    <button class="btn btn-secondary" id="btn-reset">Reset</button>
    <button class="btn btn-danger" id="btn-clear-all" style="display:none">Clear All Filters</button>
  </div>
  <div class="active-filters" id="active-filters"></div>

  <!-- Table -->
  <div class="table-section card">
    <div class="table-info" style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:8px;">
      <span><span id="table-count">Showing 0 incidents</span> <span id="table-page-info"></span></span>
      <span style="display:flex; gap:8px;">
        <button class="export-btn" onclick="exportCSV()" title="Download CSV">Export CSV</button>
        <button class="export-btn" onclick="exportExcel()" title="Download Excel">Export XLSX</button>
      </span>
    </div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th data-key="id"># <span class="sort-arrow"></span></th>
            <th data-key="offense_date">Date <span class="sort-arrow"></span></th>
            <th data-key="school">School <span class="sort-arrow"></span></th>
            <th data-key="state">State <span class="sort-arrow"></span></th>
            <th data-key="threat_type">Threat Type <span class="sort-arrow"></span></th>
            <th data-key="conveyance">Conveyance <span class="sort-arrow"></span></th>
            <th data-key="incident_details">Details <span class="sort-arrow"></span></th>
            <th data-key="gender">Gender <span class="sort-arrow"></span></th>
            <th data-key="custody">Outcome <span class="sort-arrow"></span></th>
          </tr>
        </thead>
        <tbody id="table-body"></tbody>
      </table>
    </div>
    <div class="pagination" id="pagination"></div>
  </div>
</div>

<script>
const FIPS = {
  "Alabama":"01","Alaska":"02","Arizona":"04","Arkansas":"05","California":"06",
  "Colorado":"08","Connecticut":"09","Delaware":"10","Florida":"12","Georgia":"13",
  "Hawaii":"15","Idaho":"16","Illinois":"17","Indiana":"18","Iowa":"19","Kansas":"20",
  "Kentucky":"21","Louisiana":"22","Maine":"23","Maryland":"24","Massachusetts":"25",
  "Michigan":"26","Minnesota":"27","Mississippi":"28","Missouri":"29","Montana":"30",
  "Nebraska":"31","Nevada":"32","New Hampshire":"33","New Jersey":"34","New Mexico":"35",
  "New York":"36","North Carolina":"37","North Dakota":"38","Ohio":"39","Oklahoma":"40",
  "Oregon":"41","Pennsylvania":"42","Rhode Island":"44","South Carolina":"45",
  "South Dakota":"46","Tennessee":"47","Texas":"48","Utah":"49","Vermont":"50",
  "Virginia":"51","Washington":"53","West Virginia":"54","Wisconsin":"55","Wyoming":"56",
  "Washington D.C.":"11"
};
const FIPS_REV = Object.fromEntries(Object.entries(FIPS).map(([k,v])=>[v,k]));

let allData = [], filteredData = [], sortKey = 'id', sortAsc = true, currentPage = 1;
const PAGE_SIZE = 20;
let selectedState = null;
let chartRegion, chartStates, chartTypes;

// Multi-select state
const multiSelectState = {
  'ms-type': [],
  'ms-conveyance': [],
  'ms-custody': []
};

// Chart.js defaults
Chart.defaults.color = '#9aa0b0';
Chart.defaults.borderColor = '#2a2e3f';
Chart.defaults.font.family = "-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif";

/* ---- DATE PARSING ---- */
function parseOffenseDate(val) {
  if (!val || typeof val !== 'string') return null;
  // Try standard date parse
  const d = new Date(val);
  if (!isNaN(d.getTime()) && d.getFullYear() > 2000) return d;
  // Try MM/DD/YYYY or similar
  const m = val.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
  if (m) {
    const yr = m[3].length === 2 ? 2000 + parseInt(m[3]) : parseInt(m[3]);
    const d2 = new Date(yr, parseInt(m[1]) - 1, parseInt(m[2]));
    if (!isNaN(d2.getTime())) return d2;
  }
  return null;
}

/* ---- MULTI-SELECT COMPONENT ---- */
function initMultiSelect(containerId, values, allLabel) {
  const container = document.getElementById(containerId);
  const trigger = container.querySelector('.multi-select-trigger');
  const dropdown = container.querySelector('.multi-select-dropdown');
  dropdown.innerHTML = '';

  values.filter(Boolean).sort().forEach(v => {
    const lbl = document.createElement('label');
    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.value = v;
    cb.addEventListener('change', () => {
      const checked = [...dropdown.querySelectorAll('input:checked')].map(i => i.value);
      multiSelectState[containerId] = checked;
      trigger.textContent = checked.length === 0 ? allLabel : checked.length === 1 ? checked[0] : checked.length + ' selected';
    });
    lbl.appendChild(cb);
    lbl.appendChild(document.createTextNode(v));
    dropdown.appendChild(lbl);
  });

  trigger.addEventListener('click', (e) => {
    e.stopPropagation();
    // Close other dropdowns
    document.querySelectorAll('.multi-select-dropdown.open').forEach(d => {
      if (d !== dropdown) d.classList.remove('open');
    });
    dropdown.classList.toggle('open');
  });
}

// Close multi-selects on outside click
document.addEventListener('click', () => {
  document.querySelectorAll('.multi-select-dropdown.open').forEach(d => d.classList.remove('open'));
});

/* ---- URL PARAMS ---- */
function encodeFiltersToURL() {
  const params = new URLSearchParams();
  const fs = document.getElementById('f-state').value;
  const fr = document.getElementById('f-region').value;
  const fsc = document.getElementById('f-school').value;
  const fg = document.getElementById('f-gender').value;
  const ds = document.getElementById('f-date-start').value;
  const de = document.getElementById('f-date-end').value;

  if (fs) params.set('state', fs);
  if (fr) params.set('region', fr);
  if (fsc) params.set('school', fsc);
  if (fg) params.set('gender', fg);
  if (ds) params.set('date_start', ds);
  if (de) params.set('date_end', de);
  if (multiSelectState['ms-type'].length) params.set('type', multiSelectState['ms-type'].join('|'));
  if (multiSelectState['ms-conveyance'].length) params.set('conveyance', multiSelectState['ms-conveyance'].join('|'));
  if (multiSelectState['ms-custody'].length) params.set('custody', multiSelectState['ms-custody'].join('|'));

  const qs = params.toString();
  const newURL = window.location.pathname + (qs ? '?' + qs : '');
  history.replaceState(null, '', newURL);
}

function restoreFiltersFromURL() {
  const params = new URLSearchParams(window.location.search);
  if (params.get('state')) document.getElementById('f-state').value = params.get('state');
  if (params.get('region')) document.getElementById('f-region').value = params.get('region');
  if (params.get('school')) document.getElementById('f-school').value = params.get('school');
  if (params.get('gender')) document.getElementById('f-gender').value = params.get('gender');
  if (params.get('date_start')) document.getElementById('f-date-start').value = params.get('date_start');
  if (params.get('date_end')) document.getElementById('f-date-end').value = params.get('date_end');

  ['ms-type', 'ms-conveyance', 'ms-custody'].forEach(msId => {
    const paramKey = msId === 'ms-type' ? 'type' : msId === 'ms-conveyance' ? 'conveyance' : 'custody';
    const val = params.get(paramKey);
    if (val) {
      const values = val.split('|');
      multiSelectState[msId] = values;
      const container = document.getElementById(msId);
      const dropdown = container.querySelector('.multi-select-dropdown');
      const trigger = container.querySelector('.multi-select-trigger');
      dropdown.querySelectorAll('input').forEach(cb => {
        cb.checked = values.includes(cb.value);
      });
      trigger.textContent = values.length === 1 ? values[0] : values.length + ' selected';
    }
  });
}

/* ---- FILTER COUNT ---- */
function getActiveFilterCount() {
  let count = 0;
  if (document.getElementById('f-state').value) count++;
  if (document.getElementById('f-region').value) count++;
  if (document.getElementById('f-school').value) count++;
  if (document.getElementById('f-gender').value) count++;
  if (document.getElementById('f-date-start').value) count++;
  if (document.getElementById('f-date-end').value) count++;
  if (multiSelectState['ms-type'].length) count++;
  if (multiSelectState['ms-conveyance'].length) count++;
  if (multiSelectState['ms-custody'].length) count++;
  return count;
}

function updateFilterBadge() {
  const count = getActiveFilterCount();
  const badge = document.getElementById('filter-badge');
  const clearBtn = document.getElementById('btn-clear-all');
  if (count > 0) {
    badge.textContent = count;
    badge.classList.remove('hidden');
    clearBtn.style.display = '';
  } else {
    badge.classList.add('hidden');
    clearBtn.style.display = 'none';
  }
}

async function init() {
  // Try API first, fall back to static JSON
  const apiBase = window.location.origin;
  let dataPromise;
  try {
    const resp = await fetch(`${apiBase}/api/incidents`);
    if (resp.ok) { dataPromise = resp.json(); } else { throw new Error('API unavailable'); }
  } catch {
    dataPromise = fetch('data/school_threats_2026.json').then(r => r.json());
  }
  const [data, us] = await Promise.all([
    dataPromise,
    fetch('https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json').then(r => r.json())
  ]);
  allData = data;
  filteredData = [...allData];

  populateFilters();
  restoreFiltersFromURL();
  updateStats(allData);
  drawMap(us);
  createCharts();

  // If URL had filters, apply them
  if (window.location.search) {
    applyFilters();
  } else {
    updateAll();
  }
  bindEvents();
}

function populateFilters() {
  const fill = (id, vals) => {
    const sel = document.getElementById(id);
    vals.filter(Boolean).sort().forEach(v => {
      const o = document.createElement('option'); o.value = v; o.textContent = v; sel.appendChild(o);
    });
  };
  fill('f-state', [...new Set(allData.map(d=>d.state))]);
  fill('f-region', [...new Set(allData.map(d=>d.region))]);
  fill('f-school', [...new Set(allData.map(d=>d.school_type))]);
  fill('f-gender', [...new Set(allData.map(d=>d.gender))]);

  // Multi-selects
  initMultiSelect('ms-type', [...new Set(allData.map(d=>d.threat_type))], 'All Types');
  initMultiSelect('ms-conveyance', [...new Set(allData.map(d=>d.conveyance))], 'All');
  initMultiSelect('ms-custody', [...new Set(allData.map(d=>d.custody))], 'All');
}

function updateStats(data) {
  document.getElementById('stat-total').textContent = data.length;
  const states = new Set(data.map(d=>d.state).filter(Boolean));
  document.getElementById('stat-states').textContent = states.size;
  const tc = {};
  data.forEach(d => { if(d.threat_type) tc[d.threat_type] = (tc[d.threat_type]||0)+1; });
  const top = Object.entries(tc).sort((a,b)=>b[1]-a[1]);
  document.getElementById('stat-threat').textContent = top.length ? top[0][0] : '--';
}

/* ---- MAP ---- */
let mapSvg, mapPath, stateFeatures, colorScale;

function drawMap(us) {
  const container = document.getElementById('map');
  const w = container.clientWidth, h = Math.min(w * 0.55, 560);
  const svg = d3.select('#map').append('svg').attr('viewBox', `0 0 ${w} ${h}`);
  mapSvg = svg;
  const projection = d3.geoAlbersUsa().fitSize([w, h], topojson.feature(us, us.objects.states));
  mapPath = d3.geoPath().projection(projection);
  stateFeatures = topojson.feature(us, us.objects.states).features;
  svg.selectAll('path').data(stateFeatures).join('path')
    .attr('class','state-path').attr('d', mapPath)
    .on('mouseover', mapHover).on('mousemove', mapMove).on('mouseout', mapOut)
    .on('click', mapClick);

  // legend gradient
  const bar = document.getElementById('legend-bar');
  bar.style.background = 'linear-gradient(to right, #1e3a5f, #4f8ff7, #ef4444)';
}

function updateMap() {
  const counts = {};
  filteredData.forEach(d => { if(d.state && FIPS[d.state]) counts[FIPS[d.state]] = (counts[FIPS[d.state]]||0)+1; });
  const max = Math.max(1, ...Object.values(counts));
  document.getElementById('legend-max').textContent = max;
  colorScale = d3.scaleSequential(d3.interpolateRgbBasis(['#1a2744','#1e3a5f','#4f8ff7','#e07040','#ef4444']))
    .domain([0, max]);
  mapSvg.selectAll('.state-path')
    .attr('fill', d => {
      const c = counts[String(d.id).padStart(2,'0')] || 0;
      return c > 0 ? colorScale(c) : '#1a1d27';
    })
    .classed('selected', d => selectedState && FIPS_REV[String(d.id).padStart(2,'0')] === selectedState);
}

function mapHover(e, d) {
  const fips = String(d.id).padStart(2,'0');
  const name = FIPS_REV[fips] || 'Unknown';
  const counts = {};
  filteredData.forEach(r => { if(r.state && FIPS[r.state]) counts[FIPS[r.state]] = (counts[FIPS[r.state]]||0)+1; });
  const c = counts[fips] || 0;
  const tt = document.getElementById('tooltip');
  tt.innerHTML = `<span class="tt-state">${name}</span><br><span class="tt-count">${c} incident${c!==1?'s':''}</span>`;
  tt.style.display = 'block';
}
function mapMove(e) {
  const tt = document.getElementById('tooltip');
  tt.style.left = (e.clientX + 14) + 'px';
  tt.style.top = (e.clientY - 10) + 'px';
}
function mapOut() { document.getElementById('tooltip').style.display = 'none'; }
function mapClick(e, d) {
  const fips = String(d.id).padStart(2,'0');
  const name = FIPS_REV[fips];
  if (selectedState === name) { selectedState = null; document.getElementById('f-state').value = ''; }
  else { selectedState = name; document.getElementById('f-state').value = name || ''; }
  applyFilters();
}

/* ---- CHARTS ---- */
const PALETTE = ['#4f8ff7','#ef4444','#22c55e','#f59e0b','#a78bfa','#ec4899','#06b6d4','#84cc16','#f97316','#6366f1','#14b8a6','#e879f9','#fbbf24','#fb7185'];

function createCharts() {
  chartRegion = new Chart(document.getElementById('chart-region'), {
    type: 'pie', data: { labels: [], datasets: [{ data: [], backgroundColor: PALETTE }] },
    options: { responsive: true, plugins: { legend: { position: 'bottom', labels: { padding: 14, font: { size: 12 } } } } }
  });
  chartStates = new Chart(document.getElementById('chart-states'), {
    type: 'bar', data: { labels: [], datasets: [{ data: [], backgroundColor: '#4f8ff7', borderRadius: 4, barThickness: 18 }] },
    options: {
      responsive: true, indexAxis: 'y',
      plugins: { legend: { display: false } },
      scales: { x: { grid: { color: '#2a2e3f' }, ticks: { font: { size: 11 } } }, y: { grid: { display: false }, ticks: { font: { size: 11 } } } }
    }
  });
  chartTypes = new Chart(document.getElementById('chart-types'), {
    type: 'doughnut', data: { labels: [], datasets: [{ data: [], backgroundColor: PALETTE }] },
    options: { responsive: true, plugins: { legend: { position: 'bottom', labels: { padding: 14, font: { size: 11 } } } } }
  });
}

function updateCharts() {
  // Region
  const rc = {}; filteredData.forEach(d => { if(d.region) rc[d.region] = (rc[d.region]||0)+1; });
  const rEntries = Object.entries(rc).sort((a,b)=>b[1]-a[1]);
  chartRegion.data.labels = rEntries.map(e=>e[0]);
  chartRegion.data.datasets[0].data = rEntries.map(e=>e[1]);
  chartRegion.update();

  // Top 10 states
  const sc = {}; filteredData.forEach(d => { if(d.state) sc[d.state] = (sc[d.state]||0)+1; });
  const sEntries = Object.entries(sc).sort((a,b)=>b[1]-a[1]).slice(0,10);
  chartStates.data.labels = sEntries.map(e=>e[0]);
  chartStates.data.datasets[0].data = sEntries.map(e=>e[1]);
  chartStates.update();

  // Threat types
  const tc = {}; filteredData.forEach(d => { if(d.threat_type) tc[d.threat_type] = (tc[d.threat_type]||0)+1; });
  const tEntries = Object.entries(tc).sort((a,b)=>b[1]-a[1]);
  chartTypes.data.labels = tEntries.map(e=>e[0]);
  chartTypes.data.datasets[0].data = tEntries.map(e=>e[1]);
  chartTypes.update();
}

/* ---- TABLE ---- */
function threatBadge(type) {
  if (!type) return '';
  const t = type.toLowerCase();
  let cls = 'badge-other';
  if (t.includes('bomb')) cls = 'badge-bomb';
  else if (t.includes('shooting') || t.includes('gun')) cls = 'badge-shooting';
  else if (t.includes('threat')) cls = 'badge-threat';
  return `<span class="badge ${cls}">${type}</span>`;
}

function renderTable() {
  const sorted = [...filteredData].sort((a,b) => {
    let va = a[sortKey] ?? '', vb = b[sortKey] ?? '';
    if (typeof va === 'number') return sortAsc ? va - vb : vb - va;
    va = String(va).toLowerCase(); vb = String(vb).toLowerCase();
    return sortAsc ? va.localeCompare(vb) : vb.localeCompare(va);
  });
  const total = sorted.length;
  const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
  if (currentPage > totalPages) currentPage = totalPages;
  const start = (currentPage - 1) * PAGE_SIZE;
  const page = sorted.slice(start, start + PAGE_SIZE);

  document.getElementById('table-count').textContent = `Showing ${total} incident${total!==1?'s':''}`;
  document.getElementById('table-page-info').textContent = `Page ${currentPage} of ${totalPages}`;

  const tbody = document.getElementById('table-body');
  tbody.innerHTML = '';
  page.forEach(d => {
    const tr = document.createElement('tr');
    const details = d.incident_details || '';
    tr.innerHTML = `
      <td>${d.id}</td>
      <td style="white-space:nowrap">${d.offense_date||''}</td>
      <td>${d.school||''}</td>
      <td>${d.state||''}</td>
      <td>${threatBadge(d.threat_type)}</td>
      <td>${d.conveyance||''}</td>
      <td class="details-truncated" title="${details.replace(/"/g,'&quot;')}">${details}</td>
      <td>${d.gender||''}</td>
      <td>${d.custody||''}</td>
    `;
    tr.addEventListener('click', () => {
      const next = tr.nextElementSibling;
      if (next && next.classList.contains('expanded-row')) { next.remove(); return; }
      document.querySelectorAll('.expanded-row').forEach(el=>el.remove());
      const exp = document.createElement('tr');
      exp.className = 'expanded-row';
      const fields = [
        ['School Type', d.school_type], ['Region', d.region], ['Time', d.time],
        ['Law Enforcement', d.law_enforcement], ['Who Threatened', d.who_threatened],
        ['Lockdown', d.lockdown_type], ['Evacuation', d.evacuation],
        ['Classes Cancelled', d.classes_cancelled], ['Precautions', d.precautions],
        ['Weapons', d.weapons], ['Charged', d.charged], ['Charges', d.charges],
        ['Bond', d.bond], ['Details', d.incident_details]
      ];
      exp.innerHTML = `<td colspan="9"><div class="expanded-content">${
        fields.map(([l,v]) => v && v !== 'N/A' && v !== 'Unknown' ? `<div class="field"><div class="field-label">${l}</div><div class="field-value">${v}</div></div>` : '').join('')
      }</div></td>`;
      tr.after(exp);
    });
    tbody.appendChild(tr);
  });

  // Pagination
  const pag = document.getElementById('pagination');
  pag.innerHTML = '';
  const mkBtn = (text, pg, disabled, active) => {
    const b = document.createElement('button');
    b.textContent = text; b.disabled = disabled;
    if (active) b.className = 'active';
    b.addEventListener('click', () => { currentPage = pg; renderTable(); });
    pag.appendChild(b);
  };
  mkBtn('Prev', currentPage - 1, currentPage === 1, false);
  const range = [];
  for (let i = Math.max(1, currentPage-2); i <= Math.min(totalPages, currentPage+2); i++) range.push(i);
  if (range[0] > 1) { mkBtn('1', 1, false, currentPage===1); if (range[0] > 2) { const s = document.createElement('span'); s.textContent='...'; s.style.color='var(--text-muted)'; pag.appendChild(s); } }
  range.forEach(p => mkBtn(String(p), p, false, p === currentPage));
  if (range[range.length-1] < totalPages) { if (range[range.length-1] < totalPages-1) { const s = document.createElement('span'); s.textContent='...'; s.style.color='var(--text-muted)'; pag.appendChild(s); } mkBtn(String(totalPages), totalPages, false, currentPage===totalPages); }
  mkBtn('Next', currentPage + 1, currentPage === totalPages, false);

  // Sort arrows
  document.querySelectorAll('thead th').forEach(th => {
    const arrow = th.querySelector('.sort-arrow');
    if (th.dataset.key === sortKey) arrow.textContent = sortAsc ? ' \u25B2' : ' \u25BC';
    else arrow.textContent = '';
  });
}

/* ---- FILTERS ---- */
function applyFilters() {
  const fs = document.getElementById('f-state').value;
  const fr = document.getElementById('f-region').value;
  const fsc = document.getElementById('f-school').value;
  const fg = document.getElementById('f-gender').value;
  const dateStart = document.getElementById('f-date-start').value;
  const dateEnd = document.getElementById('f-date-end').value;
  const ftypes = multiSelectState['ms-type'];
  const fconv = multiSelectState['ms-conveyance'];
  const fcust = multiSelectState['ms-custody'];

  selectedState = fs || null;

  const startDate = dateStart ? new Date(dateStart + 'T00:00:00') : null;
  const endDate = dateEnd ? new Date(dateEnd + 'T23:59:59') : null;

  filteredData = allData.filter(d => {
    if (fs && d.state !== fs) return false;
    if (fr && d.region !== fr) return false;
    if (fsc && d.school_type !== fsc) return false;
    if (fg && d.gender !== fg) return false;
    if (ftypes.length && !ftypes.includes(d.threat_type)) return false;
    if (fconv.length && !fconv.includes(d.conveyance)) return false;
    if (fcust.length && !fcust.includes(d.custody)) return false;

    // Date range filter - only filter records with parseable dates
    if (startDate || endDate) {
      const parsed = parseOffenseDate(d.offense_date);
      if (!parsed) return false;
      if (startDate && parsed < startDate) return false;
      if (endDate && parsed > endDate) return false;
    }

    return true;
  });
  currentPage = 1;
  updateAll();
  renderActiveTags();
  updateFilterBadge();
  encodeFiltersToURL();
}

function clearAllFilters() {
  ['f-state','f-region','f-school','f-gender'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('f-date-start').value = '';
  document.getElementById('f-date-end').value = '';

  // Reset multi-selects
  ['ms-type','ms-conveyance','ms-custody'].forEach(msId => {
    multiSelectState[msId] = [];
    const container = document.getElementById(msId);
    const trigger = container.querySelector('.multi-select-trigger');
    container.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
    const labels = { 'ms-type': 'All Types', 'ms-conveyance': 'All', 'ms-custody': 'All' };
    trigger.textContent = labels[msId];
  });

  selectedState = null;
  filteredData = [...allData];
  currentPage = 1;
  updateAll();
  renderActiveTags();
  updateFilterBadge();
  encodeFiltersToURL();
}

function renderActiveTags() {
  const c = document.getElementById('active-filters');
  c.innerHTML = '';
  const filters = { State: 'f-state', Region: 'f-region', 'School Type': 'f-school', Gender: 'f-gender' };

  // Standard select filters
  Object.entries(filters).forEach(([label, id]) => {
    const v = document.getElementById(id).value;
    if (v) {
      const tag = document.createElement('span');
      tag.className = 'active-filter-tag';
      tag.innerHTML = `${label}: ${v} <span style="cursor:pointer;margin-left:2px" data-clear="${id}">&times;</span>`;
      tag.querySelector('[data-clear]').addEventListener('click', e => {
        document.getElementById(e.target.dataset.clear).value = '';
        if (e.target.dataset.clear === 'f-state') selectedState = null;
        applyFilters();
      });
      c.appendChild(tag);
    }
  });

  // Date filters
  const ds = document.getElementById('f-date-start').value;
  const de = document.getElementById('f-date-end').value;
  if (ds || de) {
    const tag = document.createElement('span');
    tag.className = 'active-filter-tag';
    const rangeText = ds && de ? `${ds} to ${de}` : ds ? `From ${ds}` : `To ${de}`;
    tag.innerHTML = `Date: ${rangeText} <span style="cursor:pointer;margin-left:2px" data-clear-date>&times;</span>`;
    tag.querySelector('[data-clear-date]').addEventListener('click', () => {
      document.getElementById('f-date-start').value = '';
      document.getElementById('f-date-end').value = '';
      applyFilters();
    });
    c.appendChild(tag);
  }

  // Multi-select filters
  const msLabels = { 'ms-type': 'Threat Type', 'ms-conveyance': 'Conveyance', 'ms-custody': 'Outcome' };
  Object.entries(msLabels).forEach(([msId, label]) => {
    const vals = multiSelectState[msId];
    if (vals.length) {
      const tag = document.createElement('span');
      tag.className = 'active-filter-tag';
      const display = vals.length <= 2 ? vals.join(', ') : vals.length + ' selected';
      tag.innerHTML = `${label}: ${display} <span style="cursor:pointer;margin-left:2px" data-clear-ms="${msId}">&times;</span>`;
      tag.querySelector('[data-clear-ms]').addEventListener('click', e => {
        const id = e.target.dataset.clearMs;
        multiSelectState[id] = [];
        const container = document.getElementById(id);
        container.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
        const defaults = { 'ms-type': 'All Types', 'ms-conveyance': 'All', 'ms-custody': 'All' };
        container.querySelector('.multi-select-trigger').textContent = defaults[id];
        applyFilters();
      });
      c.appendChild(tag);
    }
  });
}

function updateAll() {
  updateStats(filteredData);
  updateMap();
  updateCharts();
  renderTable();
}

function bindEvents() {
  document.getElementById('btn-apply').addEventListener('click', applyFilters);
  document.getElementById('btn-reset').addEventListener('click', clearAllFilters);
  document.getElementById('btn-clear-all').addEventListener('click', clearAllFilters);
  document.querySelectorAll('thead th').forEach(th => {
    th.addEventListener('click', () => {
      const key = th.dataset.key;
      if (!key) return;
      if (sortKey === key) sortAsc = !sortAsc;
      else { sortKey = key; sortAsc = true; }
      renderTable();
    });
  });
}

// --- Export functions ---
const EXPORT_COLUMNS = [
  'id','school','school_type','state','region','offense_date','time',
  'law_enforcement','threat_type','conveyance','who_threatened',
  'incident_details','lockdown_type','classes_cancelled','precautions',
  'weapons','gender','charged','custody','charges','bond','source','additional_sources'
];

function buildFilterSummary() {
  const parts = [];
  const s = document.getElementById('filter-state'); if (s && s.value) parts.push(s.value);
  const d1 = document.getElementById('filter-date-start'); if (d1 && d1.value) parts.push(d1.value);
  return parts.length ? '_' + parts.join('_') : '';
}

function exportCSV() {
  const escCSV = v => { const s = String(v ?? ''); return s.includes(',') || s.includes('"') || s.includes('\n') ? '"' + s.replace(/"/g, '""') + '"' : s; };
  const lines = [EXPORT_COLUMNS.join(',')];
  filteredData.forEach(r => lines.push(EXPORT_COLUMNS.map(c => escCSV(r[c])).join(',')));
  const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `school_threats${buildFilterSummary()}.csv`;
  a.click();
  URL.revokeObjectURL(a.href);
}

function exportExcel() {
  // Build a simple XLSX using a data URI with an HTML table (opens in Excel/Sheets)
  let html = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel"><head><meta charset="UTF-8"><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>Incidents</x:Name></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--></head><body><table>';
  html += '<tr>' + EXPORT_COLUMNS.map(c => `<th>${c}</th>`).join('') + '</tr>';
  filteredData.forEach(r => {
    html += '<tr>' + EXPORT_COLUMNS.map(c => `<td>${String(r[c] ?? '').replace(/</g, '&lt;')}</td>`).join('') + '</tr>';
  });
  html += '</table></body></html>';
  const blob = new Blob([html], { type: 'application/vnd.ms-excel' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `school_threats${buildFilterSummary()}.xlsx`;
  a.click();
  URL.revokeObjectURL(a.href);
}

init();
</script>
</body>
</html>
